name: $(Rev:r)
resources:
  containers:
  - container: message_db
    image: ethangarofolo/message-db
    ports:
    - 5433:5432
jobs:
- job: Windows
  pool:
    vmImage: 'windows-latest'
  steps:
  - script: dotnet test build.proj -v n
    displayName: dotnet test build.proj
    env:
      EQUINOX_INTEGRATION_SKIP_EVENTSTORE: true
      EQUINOX_INTEGRATION_SKIP_COSMOS: true
  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: 'tests/**/*.trx'
    condition: succeededOrFailed()
  - script: dotnet pack build.proj
    displayName: dotnet pack build.proj
    env:
      BUILD_PR: $(SYSTEM.PULLREQUEST.PULLREQUESTNUMBER)
      BUILD_ID: $(BUILD.BUILDNUMBER)
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: 'bin'
      artifactName: 'nupkgs'

- job: Linux
  pool:
    vmImage: 'ubuntu-latest' 
  services:
    message_db: message_db
  steps:
  # This is to give message_db time to initialize as it's impossible to override the healthcheck timings in AZP
  # https://developercommunity.visualstudio.com/t/cant-change-service-container-healthcheck-timings/1164638
  - script: sleep 8
  - script: dotnet test build.proj -v n
    displayName: dotnet test build.proj
    env:
      EQUINOX_INTEGRATION_SKIP_EVENTSTORE: true
      EQUINOX_INTEGRATION_SKIP_COSMOS: true
  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: 'tests/**/*.trx'
    condition: succeededOrFailed()
  - script: dotnet pack build.proj
    displayName: dotnet pack
    env:
      BUILD_PR: $(SYSTEM.PULLREQUEST.PULLREQUESTNUMBER)
      BUILD_ID: $(BUILD.BUILDNUMBER)

- job: MacOS
  pool:
    vmImage: 'macOS-latest'
  steps:
  - task: UseDotNet@2
    displayName: 'Install .NET Core sdk'
    inputs:
      packageType: sdk
      version: 6.x
  - script: dotnet test build.proj -v n
    displayName: dotnet test build.proj
    env:
      EQUINOX_INTEGRATION_SKIP_EVENTSTORE: true
      EQUINOX_INTEGRATION_SKIP_COSMOS: true
  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: 'tests/**/*.trx'
    condition: succeededOrFailed()
  - script: dotnet pack build.proj
    displayName: dotnet pack
    env:
      BUILD_PR: $(SYSTEM.PULLREQUEST.PULLREQUESTNUMBER)
      BUILD_ID: $(BUILD.BUILDNUMBER)
